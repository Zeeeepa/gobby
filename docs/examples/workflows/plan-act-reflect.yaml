name: plan-act-reflect
description: "Structured development with planning, action, and reflection steps"
version: "1.0"

settings:
  reflect_after_actions: 10

steps:
  - name: plan
    description: "Analyze requirements and create implementation plan"

    on_enter:
      - action: switch_mode
        mode: plan
      - action: inject_message
        content: |
          You are in PLANNING mode. Analyze the request and create a plan.
          Do not modify any files until the plan is approved.

    allowed_tools:
      - Read
      - Glob
      - Grep
      - WebSearch
      - WebFetch
      - AskUserQuestion
      - TodoWrite

    blocked_tools:
      - Edit
      - Write
      - Bash
      - NotebookEdit

    exit_conditions:
      - type: user_approval
        prompt: "Plan complete. Ready to implement?"

  - name: act
    description: "Implement the plan"

    on_enter:
      - action: switch_mode
        mode: act
      - action: inject_message
        content: |
          You are now in IMPLEMENTATION mode. Follow the plan.

    allowed_tools: all

    transitions:
      - to: reflect
        when: "step_action_count >= 10"
      - to: reflect
        when: "tool_result.is_error"

  - name: reflect
    description: "Review progress and decide next steps"

    on_enter:
      - action: switch_mode
        mode: reflect
      - action: inject_message
        content: |
          REFLECTION CHECKPOINT

          Actions taken: {{ state.step_action_count or 0 }}

          Review your progress.
          - If done, mark task complete.
          - If issues, replan.
          - Otherwise, continue acting.

    allowed_tools:
      - Read
      - Glob
      - Grep
      - TodoWrite
      - AskUserQuestion

    blocked_tools:
      - Edit
      - Write
      - Bash

    transitions:
      - to: act
        when: "user_says('continue') or user_says('proceed')"
      - to: plan
        when: "user_says('revise') or user_says('replan')"

triggers:
  on_session_start:
    # Load persisted workflow state first
    - action: load_workflow_state

    # Only enter plan step if no persisted step exists
    - action: enter_step
      step: plan
      when: "not workflow_state.step"

  on_state_change:
    # Persist state when step changes
    - action: save_workflow_state

  on_session_end:
    # Save state when session ends
    - action: save_workflow_state
