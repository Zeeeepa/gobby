============================= test session starts ==============================
platform darwin -- Python 3.12.12, pytest-9.0.2, pluggy-1.6.0 -- /Users/josh/Projects/gobby/.venv/bin/python
cachedir: .pytest_cache
rootdir: /Users/josh/Projects/gobby
configfile: pyproject.toml
plugins: mock-3.15.1, anyio-4.12.0, asyncio-1.3.0, cov-7.0.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 1 item

tests/e2e/test_worktrees_e2e.py::TestWorktreeDeletion::test_delete_worktree_removes_branch DEBUG: src_dir=/Users/josh/Projects/gobby/src PYTHONPATH=/Users/josh/Projects/gobby/src
ERROR/Users/josh/Projects/gobby/.venv/lib/python3.12/site-packages/coverage/inorout.py:521: CoverageWarning: Module gobby was never imported. (module-not-imported); see https://coverage.readthedocs.io/en/7.13.0/messages.html#warning-module-not-imported
  self.warn(f"Module {pkg} was never imported.", slug="module-not-imported")
/Users/josh/Projects/gobby/.venv/lib/python3.12/site-packages/coverage/control.py:957: CoverageWarning: No data was collected. (no-data-collected); see https://coverage.readthedocs.io/en/7.13.0/messages.html#warning-no-data-collected
  self._warn("No data was collected.", slug="no-data-collected")
/Users/josh/Projects/gobby/.venv/lib/python3.12/site-packages/pytest_cov/plugin.py:363: CovReportWarning: Failed to generate report: No data to report.

  warnings.warn(CovReportWarning(message), stacklevel=1)

WARNING: Failed to generate report: No data to report.


ERROR: Coverage failure: total of 0 is less than fail-under=80


==================================== ERRORS ====================================
__ ERROR at setup of TestWorktreeDeletion.test_delete_worktree_removes_branch __

fixturedef = <FixtureDef argname='daemon_instance' scope='function' baseid='tests/e2e'>
request = <SubRequest 'daemon_instance' for <Function test_delete_worktree_removes_branch>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
>               return (yield)
                        ^^^^^

.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:730: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

e2e_project_dir = PosixPath('/var/folders/s9/818ytv8923v72hrbbgt2g58m0000gn/T/gobby_e2e_nkjinu4o')
e2e_config = (PosixPath('/var/folders/s9/818ytv8923v72hrbbgt2g58m0000gn/T/gobby_e2e_nkjinu4o/.gobby-home/config.yaml'), 52941, 52942)

    @pytest.fixture(scope="function")
    def daemon_instance(
        e2e_project_dir: Path,
        e2e_config: tuple[Path, int, int],
    ) -> Generator[DaemonInstance, None, None]:
        """
        Spawn an isolated daemon instance for E2E testing.
    
        Yields a DaemonInstance with running daemon, then cleans up on teardown.
        """
        config_path, http_port, ws_port = e2e_config
        gobby_home = config_path.parent
        log_dir = gobby_home / "logs"
    
        log_file = log_dir / "daemon.log"
        error_log_file = log_dir / "daemon_error.log"
    
        # Environment with custom config
        env = os.environ.copy()
        env["GOBBY_CONFIG"] = str(config_path)
        env["GOBBY_HOME"] = str(gobby_home)
        # Disable any LLM providers to avoid external calls
        env["ANTHROPIC_API_KEY"] = ""
        env["OPENAI_API_KEY"] = ""
        env["GEMINI_API_KEY"] = ""
    
        # Ensure daemon uses the local source code
        root_dir = Path(__file__).parent.parent.parent
        src_dir = root_dir / "src"
        current_pythonpath = env.get("PYTHONPATH", "")
        env["PYTHONPATH"] = f"{src_dir}:{current_pythonpath}" if current_pythonpath else str(src_dir)
        print(f"DEBUG: src_dir={src_dir} PYTHONPATH={env['PYTHONPATH']}")
    
        # Start daemon process
        with open(log_file, "w") as log_f, open(error_log_file, "w") as err_f:
            process = subprocess.Popen(
                [sys.executable, "-m", "gobby.runner", "--config", str(config_path)],
                stdout=log_f,
                stderr=err_f,
                stdin=subprocess.DEVNULL,
                cwd=str(e2e_project_dir),
                env=env,
                start_new_session=True,
            )
    
        instance = DaemonInstance(
            process=process,
            pid=process.pid,
            http_port=http_port,
            ws_port=ws_port,
            project_dir=e2e_project_dir,
            gobby_dir=e2e_project_dir / ".gobby",
            log_file=log_file,
            error_log_file=error_log_file,
            db_path=gobby_home / "gobby.db",
            config_path=config_path,
        )
    
        # Wait for daemon to be healthy
        if not wait_for_daemon_health(http_port, timeout=20.0):
            # Daemon failed to start - capture logs for debugging
            logs = instance.read_logs()
            error_logs = instance.read_error_logs()
            terminate_process_tree(process.pid)
>           pytest.fail(
                f"Daemon failed to start within timeout.\nLogs:\n{logs}\nError logs:\n{error_logs}"
            )
E           Failed: Daemon failed to start within timeout.
E           Logs:
E           
E           Error logs:
E           DEBUG: runner.py loaded from /Users/josh/Projects/gobby/src/gobby/runner.py
E           DEBUG: sys.path: ['/private/var/folders/s9/818ytv8923v72hrbbgt2g58m0000gn/T/gobby_e2e_nkjinu4o', '/Users/josh/Projects/gobby/src', '/Users/josh/.local/share/uv/python/cpython-3.12.12-macos-aarch64-none/lib/python312.zip', '/Users/josh/.local/share/uv/python/cpython-3.12.12-macos-aarch64-none/lib/python3.12', '/Users/josh/.local/share/uv/python/cpython-3.12.12-macos-aarch64-none/lib/python3.12/lib-dynload', '/Users/josh/Projects/gobby/.venv/lib/python3.12/site-packages']
E           Fatal error: unmatched ')' (git.py, line 227)
E           Traceback (most recent call last):
E             File "/Users/josh/Projects/gobby/src/gobby/runner.py", line 467, in main
E               asyncio.run(run_gobby(config_path=config_path, verbose=verbose))
E             File "/Users/josh/.local/share/uv/python/cpython-3.12.12-macos-aarch64-none/lib/python3.12/asyncio/runners.py", line 195, in run
E               return runner.run(main)
E                      ^^^^^^^^^^^^^^^^
E             File "/Users/josh/.local/share/uv/python/cpython-3.12.12-macos-aarch64-none/lib/python3.12/asyncio/runners.py", line 118, in run
E               return self._loop.run_until_complete(task)
E                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E             File "/Users/josh/.local/share/uv/python/cpython-3.12.12-macos-aarch64-none/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
E               return future.result()
E                      ^^^^^^^^^^^^^^^
E             File "/Users/josh/Projects/gobby/src/gobby/runner.py", line 461, in run_gobby
E               runner = GobbyRunner(config_path=config_path, verbose=verbose)
E                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E             File "/Users/josh/Projects/gobby/src/gobby/runner.py", line 193, in __init__
E               self.http_server = HTTPServer(
E                                  ^^^^^^^^^^^
E             File "/Users/josh/Projects/gobby/src/gobby/servers/http.py", line 152, in __init__
E               from gobby.worktrees.merge.resolver import MergeResolver
E             File "/Users/josh/Projects/gobby/src/gobby/worktrees/__init__.py", line 3, in <module>
E               from gobby.worktrees.git import WorktreeGitManager
E             File "/Users/josh/Projects/gobby/src/gobby/worktrees/git.py", line 227
E               )
E               ^
E           SyntaxError: unmatched ')'

tests/e2e/conftest.py:278: Failed
================================ tests coverage ================================
______________ coverage: platform darwin, python 3.12.12-final-0 _______________

FAIL Required test coverage of 80% not reached. Total coverage: 0.00%
=========================== short test summary info ============================
ERROR tests/e2e/test_worktrees_e2e.py::TestWorktreeDeletion::test_delete_worktree_removes_branch - Failed: Daemon failed to start within timeout.
Logs:

Error logs:
DEBUG: runner.py loaded from /Users/josh/Projects/gobby/src/gobby/runner.py
DEBUG: sys.path: ['/private/var/folders/s9/818ytv8923v72hrbbgt2g58m0000gn/T/gobby_e2e_nkjinu4o', '/Users/josh/Projects/gobby/src', '/Users/josh/.local/share/uv/python/cpython-3.12.12-macos-aarch64-none/lib/python312.zip', '/Users/josh/.local/share/uv/python/cpython-3.12.12-macos-aarch64-none/lib/python3.12', '/Users/josh/.local/share/uv/python/cpython-3.12.12-macos-aarch64-none/lib/python3.12/lib-dynload', '/Users/josh/Projects/gobby/.venv/lib/python3.12/site-packages']
Fatal error: unmatched ')' (git.py, line 227)
Traceback (most recent call last):
  File "/Users/josh/Projects/gobby/src/gobby/runner.py", line 467, in main
    asyncio.run(run_gobby(config_path=config_path, verbose=verbose))
  File "/Users/josh/.local/share/uv/python/cpython-3.12.12-macos-aarch64-none/lib/python3.12/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/Users/josh/.local/share/uv/python/cpython-3.12.12-macos-aarch64-none/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/josh/.local/share/uv/python/cpython-3.12.12-macos-aarch64-none/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/Users/josh/Projects/gobby/src/gobby/runner.py", line 461, in run_gobby
    runner = GobbyRunner(config_path=config_path, verbose=verbose)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/josh/Projects/gobby/src/gobby/runner.py", line 193, in __init__
    self.http_server = HTTPServer(
                       ^^^^^^^^^^^
  File "/Users/josh/Projects/gobby/src/gobby/servers/http.py", line 152, in __init__
    from gobby.worktrees.merge.resolver import MergeResolver
  File "/Users/josh/Projects/gobby/src/gobby/worktrees/__init__.py", line 3, in <module>
    from gobby.worktrees.git import WorktreeGitManager
  File "/Users/josh/Projects/gobby/src/gobby/worktrees/git.py", line 227
    )
    ^
SyntaxError: unmatched ')'
============================== 1 error in 20.37s ===============================
