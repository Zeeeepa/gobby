name: code-review
description: |
  Review worker's code changes before merging.

  This workflow can be used standalone or embedded in orchestrators.
  It guides the reviewer through:
  1. Fetching the diff from the worker's branch
  2. Analyzing code quality, tests, and security
  3. Approving or requesting changes

version: "1.0"
type: step

variables:
  worktree_id: null      # Set by parent
  branch_name: null      # Set by parent
  task_id: null          # Set by parent
  review_approved: false
  review_rejected: false
  deficiencies: []

steps:
  - name: fetch_changes
    description: "Get diff from worker's branch"
    on_enter:
      - action: inject_message
        content: |
          CODE REVIEW: Fetching changes.

          Worktree: {{ variables.worktree_id }}
          Branch: {{ variables.branch_name }}
          Task: {{ variables.task_id }}

          Review the changes:

          1. Get the diff:
             git diff main...{{ variables.branch_name }}

          2. List changed files:
             git diff --name-only main...{{ variables.branch_name }}

          3. Check commit messages:
             git log main..{{ variables.branch_name }} --oneline

    allowed_tools:
      - Bash
      - Read
      - Glob
      - Grep

    blocked_tools:
      - Edit
      - Write
      - NotebookEdit
      - spawn_agent

    transitions:
      - to: review
        when: "true"

  - name: review
    description: "Analyze code quality, tests, security"
    on_enter:
      - action: inject_message
        content: |
          CODE REVIEW: Analysis phase.

          Check the following:

          1. **Code Quality**
             - Clean, readable code
             - Follows project conventions
             - No obvious bugs

          2. **Tests**
             - New code has tests (if applicable)
             - Existing tests pass
             - Run: pytest or npm test

          3. **Security**
             - No hardcoded secrets
             - Input validation
             - No SQL injection, XSS, etc.

          4. **Documentation**
             - Comments where needed
             - README updates if applicable

          After review, set the result:
          - Approved: set_workflow_variable("review_approved", true)
          - Rejected: set_workflow_variable("review_rejected", true)
            and: set_workflow_variable("deficiencies", ["list", "of", "issues"])

    allowed_tools:
      - Bash
      - Read
      - Glob
      - Grep
      - mcp__gobby__call_tool
      - mcp__gobby__list_tools
      - mcp__gobby__get_tool_schema

    blocked_tools:
      - Edit
      - Write
      - NotebookEdit
      - spawn_agent

    transitions:
      - to: complete
        when: "variables.get('review_approved', False)"
      - to: request_changes
        when: "variables.get('review_rejected', False)"

  - name: request_changes
    description: "Document deficiencies for worker"
    on_enter:
      - action: inject_message
        content: |
          CODE REVIEW: Changes requested.

          Deficiencies found:
          {% for d in variables.deficiencies %}
          - {{ d }}
          {% endfor %}

          The worker will be respawned to address these issues.
          This step is informational - the parent orchestrator handles respawning.

    allowed_tools:
      - Read
      - mcp__gobby__call_tool

    blocked_tools:
      - Edit
      - Write
      - NotebookEdit
      - Bash

    transitions:
      - to: complete
        when: "true"

  - name: complete
    description: "Review complete"

exit_condition: "current_step == 'complete'"
