name: autonomous-task
description: |
  Autonomous task execution workflow with proper state machine semantics.
  Activates with a session_task and stays active until the task tree is complete.

  Key features:
  - Explicit state machine with work/complete steps
  - Clear entry/exit points (activate with task, exit when complete)
  - Opt-in activation (must be explicitly started)
  - Proper loop that stays in 'work' until task_tree_complete()

  Usage:
    1. Create/claim a task via gobby-tasks
    2. Activate this workflow with session_task set to the task ID
    3. Work autonomously until all subtasks are closed
    4. Workflow exits when task tree is complete

  This replaces the stop-blocking pattern in session-lifecycle.yaml with
  proper state machine semantics.
version: "1.0"
type: step

# Session-scoped variables (set on activation)
variables:
  session_task: null  # Task ID(s) to complete before exit
  # Failsafe: force allow stop after N blocked attempts (resets on user prompt)
  premature_stop_max_attempts: 3

steps:
  - name: work
    description: "Work on assigned task until complete"

    on_enter:
      - action: inject_message
        content: |
          You are in autonomous task execution mode.

          Session task: {{ variables.session_task }}

          Work on this task and its subtasks until completion.
          Use suggest_next_task() to find available work.
          When all subtasks are closed, the task will be marked complete.

    # No tool restrictions - full autonomy
    allowed_tools: all

    # Auto-transition to complete when task tree is done
    transitions:
      - to: complete
        when: "task_tree_complete(variables.session_task)"

  - name: complete
    description: "Task work finished - terminal step"

    on_enter:
      - action: inject_message
        content: |
          Task complete! All subtasks for {{ variables.session_task }} have been closed.

          The autonomous-task workflow will now exit.
          You may stop the session or start a new task.

# Exit condition for entire workflow
# When this evaluates to true, the workflow can cleanly exit
# Uses task_tree_complete directly so stop is allowed when tasks are done
# (even if transition to 'complete' step hasn't fired yet)
exit_condition: "task_tree_complete(variables.session_task)"

# Handler for premature stop attempts
# Triggered when agent tries to stop but exit_condition is not met
on_premature_stop:
  action: guide_continuation
  message: "Task has incomplete subtasks. Use suggest_next_task() and continue working. Do not wait for user confirmation to proceed."
