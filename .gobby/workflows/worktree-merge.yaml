name: worktree-merge
description: |
  Merge approved branch and cleanup worktree.

  This workflow handles the final stage of the task lifecycle:
  1. Merge the feature branch into target (usually dev)
  2. Delete the worktree
  3. Optionally delete the feature branch

version: "1.0"
type: step

variables:
  worktree_id: null
  branch_name: null
  target_branch: dev
  merge_strategy: squash  # merge, squash, or rebase
  delete_branch: true
  merge_complete: false
  cleanup_complete: false

steps:
  - name: merge
    description: "Merge branch into target"
    on_enter:
      - action: inject_message
        content: |
          MERGE: Starting merge.

          Branch: {{ variables.branch_name }}
          Target: {{ variables.target_branch }}
          Strategy: {{ variables.merge_strategy }}

          Execute the merge:

          {% if variables.merge_strategy == 'squash' %}
          git checkout {{ variables.target_branch }}
          git merge --squash {{ variables.branch_name }}
          git commit -m "Merge {{ variables.branch_name }} (squashed)"
          {% elif variables.merge_strategy == 'rebase' %}
          git checkout {{ variables.branch_name }}
          git rebase {{ variables.target_branch }}
          git checkout {{ variables.target_branch }}
          git merge --ff-only {{ variables.branch_name }}
          {% else %}
          git checkout {{ variables.target_branch }}
          git merge {{ variables.branch_name }}
          {% endif %}

          After successful merge, set merge_complete to true:
          set_workflow_variable("merge_complete", true)

    allowed_tools:
      - Bash
      - Read
      - mcp__gobby__call_tool
      - mcp__gobby__list_tools
      - mcp__gobby__get_tool_schema

    blocked_tools:
      - Edit
      - Write
      - NotebookEdit

    transitions:
      - to: cleanup
        when: "variables.get('merge_complete', False)"

  - name: cleanup
    description: "Delete the worktree and branch"
    on_enter:
      - action: inject_message
        content: |
          MERGE: Cleaning up.

          Worktree: {{ variables.worktree_id }}
          Delete branch: {{ variables.delete_branch }}

          Remove the worktree:

          mcp__gobby__call_tool(
            server_name="gobby-worktrees",
            tool_name="delete_worktree",
            arguments={"worktree_id": "{{ variables.worktree_id }}"}
          )

          Or manually:
          git worktree remove <path>
          {% if variables.delete_branch %}
          git branch -D {{ variables.branch_name }}
          {% endif %}

          After cleanup, set cleanup_complete to true:
          set_workflow_variable("cleanup_complete", true)

    allowed_tools:
      - Bash
      - mcp__gobby__call_tool
      - mcp__gobby__list_tools
      - mcp__gobby__get_tool_schema

    blocked_tools:
      - Edit
      - Write
      - NotebookEdit
      - Read

    transitions:
      - to: complete
        when: "variables.get('cleanup_complete', False)"

  - name: complete
    description: "Merge and cleanup done"
    on_enter:
      - action: inject_message
        content: |
          MERGE: Complete!

          Branch {{ variables.branch_name }} has been merged into {{ variables.target_branch }}.
          Worktree {{ variables.worktree_id }} has been removed.

exit_condition: "current_step == 'complete'"
