name: work-task-gemini
description: |
  Simplified worker workflow for Gemini agents spawned in git worktrees.

  This workflow is designed to be activated by a parent orchestrator (auto-task-claude)
  for agents running in isolated git worktrees. It provides:

  1. Claim the assigned task (set to in_progress)
  2. Work on the task with full tool access
  3. Commit changes to the worktree branch
  4. Close the task
  5. Report completion to parent
  6. Shutdown

  The parent sets assigned_task_id via spawn_agent task_id parameter.

version: "1.0"
type: step

variables:
  assigned_task_id: null
  task_claimed: false
  task_closed: false
  parent_notified: false

steps:
  - name: claim_task
    description: "Claim the assigned task"
    on_enter:
      - action: inject_message
        content: |
          WORKER: Starting in worktree.

          You are running in an isolated git worktree. Your changes will be
          committed to a feature branch that can be merged later.

          Assigned task: {{ variables.assigned_task_id }}

          First, claim the task by setting it to in_progress:

          mcp__gobby__call_tool(
            server_name="gobby-tasks",
            tool_name="update_task",
            arguments={
              "task_id": "{{ variables.assigned_task_id }}",
              "status": "in_progress"
            }
          )

          Then read the task details to understand what needs to be done:

          mcp__gobby__call_tool(
            server_name="gobby-tasks",
            tool_name="get_task",
            arguments={"task_id": "{{ variables.assigned_task_id }}"}
          )

    allowed_tools:
      - mcp__gobby__call_tool
      - mcp__gobby__list_tools
      - mcp__gobby__get_tool_schema
      - Read
      - Glob
      - Grep

    blocked_tools:
      - Edit
      - Write
      - Bash
      - NotebookEdit
      - spawn_agent

    on_mcp_success:
      - server: gobby-tasks
        tool: update_task
        action: set_variable
        variable: task_claimed
        value: true

    transitions:
      - to: work
        when: "variables.get('task_claimed', False)"

  - name: work
    description: "Full tool access for implementation"
    on_enter:
      - action: inject_message
        content: |
          WORKER: Implementation phase.

          Task: {{ variables.assigned_task_id }}

          You now have full tool access. Complete the task:
          1. Read the task details to understand what needs to be done
          2. Execute the required work (may involve file edits, API calls, or just gathering information)
          3. Run tests if applicable

          IMPORTANT: Closing the task depends on what type of work you did:

          **If you made file changes:**
          1. Stage your changes: git add <files>
          2. Commit with task reference: git commit -m "[{{ variables.assigned_task_id }}] Description"
          3. Close the task WITH commit_sha:
             mcp__gobby__call_tool(
               server_name="gobby-tasks",
               tool_name="close_task",
               arguments={
                 "task_id": "{{ variables.assigned_task_id }}",
                 "commit_sha": "<commit_sha_from_git_commit>"
               }
             )

          **If NO file changes (e.g., research, messaging, information gathering):**
          Close the task WITHOUT commit_sha:
             mcp__gobby__call_tool(
               server_name="gobby-tasks",
               tool_name="close_task",
               arguments={
                 "task_id": "{{ variables.assigned_task_id }}",
                 "changes_summary": "<brief summary of what you did>"
               }
             )

          Do NOT push - the parent orchestrator will handle merging.

    allowed_tools: all

    blocked_tools:
      - spawn_agent

    on_mcp_success:
      - server: gobby-tasks
        tool: close_task
        action: set_variable
        variable: task_closed
        value: true

    transitions:
      - to: report_to_parent
        when: "variables.get('task_closed', False)"

  - name: report_to_parent
    description: "Notify parent of completion"
    on_enter:
      - action: inject_message
        content: |
          WORKER: Reporting completion to parent.

          Send a completion message to your parent session:

          mcp__gobby__call_tool(
            server_name="gobby-agents",
            tool_name="send_to_parent",
            arguments={
              "session_id": "<your_session_id>",
              "content": "Task {{ variables.assigned_task_id }} completed. <brief summary of what you did>"
            }
          )

          If send_to_parent fails (no parent found), that's okay - proceed to shutdown.

    allowed_tools:
      - mcp__gobby__call_tool
      - mcp__gobby__list_tools
      - mcp__gobby__get_tool_schema
      - Read

    blocked_tools:
      - Edit
      - Write
      - Bash
      - NotebookEdit

    on_mcp_success:
      - server: gobby-agents
        tool: send_to_parent
        action: set_variable
        variable: parent_notified
        value: true

    on_mcp_error:
      - server: gobby-agents
        tool: send_to_parent
        action: set_variable
        variable: parent_notified
        value: true

    transitions:
      - to: shutdown
        when: "mcp_called('gobby-agents', 'send_to_parent')"

  - name: shutdown
    description: "Clean shutdown"
    on_enter:
      - action: inject_message
        content: |
          WORKER: Shutdown sequence.

          Update your session status to completed:

          mcp__gobby__call_tool(
            server_name="gobby-sessions",
            tool_name="update_session",
            arguments={
              "session_id": "$GOBBY_SESSION_ID",
              "status": "completed"
            }
          )

          Note: Replace $GOBBY_SESSION_ID with the value from environment variable GOBBY_SESSION_ID.

          Then run the shutdown script (if available):
          ~/.gobby/scripts/agent_shutdown.sh

          This will terminate your terminal session.

    allowed_tools:
      - Bash
      - mcp__gobby__call_tool

    blocked_tools:
      - Edit
      - Write
      - NotebookEdit

    transitions:
      - to: complete
        when: "mcp_called('gobby-sessions', 'update_session')"

  - name: complete
    description: "Worker done"

exit_condition: "current_step == 'complete'"

on_premature_stop:
  action: block
  message: |
    Cannot stop - task not complete.

    You must:
    1. Complete your work
    2. If you made file changes: commit them (git add && git commit)
    3. Close the task with close_task() (commit_sha optional if no file changes)
    4. Report to parent with send_to_parent()

    If you're stuck, check the task details with get_task().
