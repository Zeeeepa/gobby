name: meeseeks
description: |
  Autonomous task worker with full lifecycle: spawn -> work -> review -> merge.
  "Hi, I'm Mr. Meeseeks! Look at me!"

  Supports multiple workflows via the `workflows` map:
  - box: Interactive orchestrator (Claude Code terminal) - DEFAULT
  - box-pipeline: Automated orchestrator (daemon background)
  - worker: Task executor (Gemini in worktree)
  - code-review: Review worker changes
  - worktree-merge: Merge and cleanup

  Usage:
    spawn_agent(meeseeks)                     # Uses box (interactive)
    spawn_agent(meeseeks, workflow="worker")  # Direct worker spawn

mode: terminal
provider: gemini
model: gemini-3-pro-preview
isolation: worktree
# base_branch: auto-detected from caller's current branch

# Named workflows - select via spawn_agent(workflow="...")
workflows:
  # Interactive orchestrator (activates in caller session)
  box:
    file: meeseeks-box.yaml
    mode: self  # Activate workflow in calling session instead of spawning

  # Automated orchestrator (runs in daemon background)
  box-pipeline:
    file: meeseeks-box-pipeline.yaml

  # Worker: claims and executes a single task (runs in Gemini)
  worker:
    type: step
    description: "Worker workflow for Gemini agents in worktrees"
    variables:
      assigned_task_id: null
      task_claimed: false
      task_closed: false
      parent_notified: false

    # Worker workflow starts at claim_task - spawn_agent handles activation
    steps:
      - name: claim_task
        description: "Claim the assigned task"
        on_enter:
          - action: inject_message
            content: |
              WORKER: Starting in worktree.

              You are running in an isolated git worktree. Your changes will be
              committed to a feature branch that can be merged later.

              Assigned task: {{ variables.assigned_task_id }}

              First, claim the task by calling claim_task:
              - server_name: "gobby-tasks"
              - tool_name: "claim_task"
              - arguments: {"task_id": "{{ variables.assigned_task_id }}", "session_id": "<your_session_id>"}

              Then read the task details using the get_task tool:
              - server_name: "gobby-tasks"
              - tool_name: "get_task"
              - arguments: {"task_id": "{{ variables.assigned_task_id }}"}

        allowed_tools:
          - mcp__gobby__call_tool
          - mcp__gobby__list_tools
          - mcp__gobby__get_tool_schema
          - Read
          - Glob
          - Grep

        blocked_tools:
          - Edit
          - Write
          - Bash
          - NotebookEdit
          - spawn_agent
          - activate_workflow

        on_mcp_success:
          - server: gobby-tasks
            tool: claim_task
            action: set_variable
            variable: task_claimed
            value: true

        transitions:
          - to: work
            when: "task_claimed"

      - name: work
        description: "Full tool access for implementation"
        on_enter:
          - action: inject_message
            content: |
              WORKER: Implementation phase.

              Task: {{ variables.assigned_task_id }}

              You now have full tool access. Complete the task:
              1. Read the task details to understand what needs to be done
              2. Execute the required work (may involve file edits, API calls, or just gathering information)
              3. Run tests if applicable

              IMPORTANT: Closing the task depends on what type of work you did:

              **If you made file changes:**
              1. Stage your changes: git add <files>
              2. Commit with task reference: git commit -m "[{{ variables.assigned_task_id }}] Description"
              3. Close the task WITH commit_sha using the close_task tool:
                 - server_name: "gobby-tasks"
                 - tool_name: "close_task"
                 - arguments: {"task_id": "{{ variables.assigned_task_id }}", "commit_sha": "<sha_from_git_commit>"}

              **If NO file changes (e.g., research, messaging, information gathering):**
              Close the task WITHOUT commit_sha:
                 - server_name: "gobby-tasks"
                 - tool_name: "close_task"
                 - arguments: {"task_id": "{{ variables.assigned_task_id }}", "changes_summary": "<brief summary>"}

              Do NOT push - the parent orchestrator will handle merging.

        allowed_tools: all

        blocked_tools:
          - spawn_agent
          - activate_workflow

        on_mcp_success:
          - server: gobby-tasks
            tool: close_task
            action: set_variable
            variable: task_closed
            value: true

        transitions:
          - to: report_to_parent
            when: "task_closed"

      - name: report_to_parent
        description: "Notify parent of completion"
        on_enter:
          - action: inject_message
            content: |
              WORKER: Reporting completion to parent.

              Send a completion message to your parent session using the send_to_parent tool:
              - server_name: "gobby-agents"
              - tool_name: "send_to_parent"
              - arguments: {"session_id": "YOUR_GOBBY_SESSION_ID", "content": "Task {{ variables.assigned_task_id }} completed. <brief summary>"}

              NOTE: Use your Gobby Session ID (shown at session start as "Gobby Session ID: #N" or UUID).
              Do NOT use the CLI-specific external_id. The Gobby Session ID is what MCP tools expect.

              If send_to_parent fails (no parent found), that's okay - proceed to shutdown.

        allowed_tools:
          - mcp__gobby__call_tool
          - mcp__gobby__list_tools
          - mcp__gobby__get_tool_schema
          - Read

        blocked_tools:
          - Edit
          - Write
          - Bash
          - NotebookEdit
          - activate_workflow

        on_mcp_success:
          - server: gobby-agents
            tool: send_to_parent
            action: set_variable
            variable: parent_notified
            value: true

        on_mcp_error:
          - server: gobby-agents
            tool: send_to_parent
            action: set_variable
            variable: parent_notified
            value: true

        transitions:
          - to: shutdown
            when: "mcp_called('gobby-agents', 'send_to_parent')"

      - name: shutdown
        description: "Clean shutdown"
        on_enter:
          - action: inject_message
            content: |
              WORKER: Shutdown sequence.

              Close your terminal using the close_terminal MCP tool:
              - server_name: "gobby-workflows"
              - tool_name: "close_terminal"
              - arguments: {"session_id": "YOUR_GOBBY_SESSION_ID"}

              NOTE: Use your Gobby Session ID (shown at session start as "Gobby Session ID: #N" or UUID).
              Do NOT use the CLI-specific external_id.

              This will terminate your terminal session cleanly.

        allowed_tools:
          - mcp__gobby__call_tool
          - mcp__gobby__get_tool_schema

        blocked_tools:
          - Edit
          - Write
          - NotebookEdit
          - Bash
          - activate_workflow

        transitions:
          - to: complete
            when: "mcp_called('gobby-workflows', 'close_terminal')"

      - name: complete
        description: "Worker done"

    exit_condition: "current_step == 'complete'"

    on_premature_stop:
      action: block
      message: |
        Cannot stop - task not complete.

        You must:
        1. Complete your work
        2. If you made file changes: commit them (git add && git commit)
        3. Close the task using the close_task tool (include commit_sha if you made file changes)
        4. Report to parent using the send_to_parent tool

        If you're stuck, check the task details using the get_task tool.

  # Code review workflow
  code-review:
    file: code-review.yaml

  # Worktree merge workflow
  worktree-merge:
    file: worktree-merge.yaml

# Default workflow when spawn_agent(meeseeks) called without workflow param
default_workflow: box

timeout: 600.0
max_turns: 200

sandbox:
  enabled: true
  mode: permissive
  allow_network: true
