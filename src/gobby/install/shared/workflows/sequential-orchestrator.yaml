name: sequential-orchestrator
description: |
  Farm out subtasks to Gemini sequentially in a single worktree.
  Claude orchestrates, Gemini executes. No auto-merge.

version: "1.0"
type: step

variables:
  session_task: null          # Epic/parent task ID
  target_branch: "dev"        # Branch to merge into (configurable)
  worktree_id: null           # Created worktree ID
  worktree_path: null         # Path to worktree
  coding_provider: "gemini"   # Provider for subtasks
  spawn_mode: "terminal"      # Mode for spawning subagents (terminal, in_process, embedded, headless)
  current_agent_run_id: null  # Track spawned agent

steps:
  - name: setup
    description: "Create worktree for epic if needed"
    on_enter:
      - action: inject_message
        content: |
          Sequential orchestration mode active.

          Epic task: {{ variables.session_task }}

          First, ensure a worktree exists for this epic.
          Call create_worktree() with branch "epic/{{ variables.session_task }}"
          Then set worktree_id and worktree_path variables.

          After setup, transition to 'spawn' step.

    allowed_tools: all

    transitions:
      - to: spawn
        when: "variables.worktree_id is not None"

  - name: spawn
    description: "Spawn Gemini on next ready task"
    on_enter:
      - action: inject_message
        content: |
          Get the next ready task with suggest_next_task(session_id=<your_session_id>).
          This will auto-scope to subtasks of {{ variables.session_task }}.

          If a task is available:
          - Spawn Gemini in the worktree: {{ variables.worktree_path }}
          - Use start_agent() with:
            - provider: {{ variables.coding_provider }}
            - mode: {{ variables.spawn_mode }}
            - project_path: {{ variables.worktree_path }}
            - task: <task_id>
            - workflow: "auto-task"
          - Store the run_id in current_agent_run_id variable
          - Transition to 'wait' step

          If no tasks ready but task tree incomplete:
          - Check if blocked tasks exist
          - May need to wait for dependencies

          If task_tree_complete:
          - Transition to 'review' step

    allowed_tools: all

    transitions:
      - to: wait
        when: "variables.current_agent_run_id is not None"
      - to: review
        when: "task_tree_complete(variables.session_task)"

  - name: wait
    description: "Wait for Gemini to complete current task"
    on_enter:
      - action: inject_message
        content: |
          Gemini is working on a task. Monitor progress.

          Poll with get_agent_result(run_id="{{ variables.current_agent_run_id }}")

          When agent completes (status: success/error/timeout):
          - Clear current_agent_run_id
          - Transition back to 'spawn' for next task

          If agent failed, note the error but continue to next task.

    allowed_tools: all

    transitions:
      - to: spawn
        when: "variables.current_agent_run_id is None"

  - name: review
    description: "All tasks complete - review the worktree"
    on_enter:
      - action: inject_message
        content: |
          All subtasks have been completed!

          Worktree: {{ variables.worktree_path }}

          Please review the changes in the worktree:
          1. Check git log for commits
          2. Review key files that were modified
          3. Run tests if applicable
          4. Summarize what was accomplished

          When ready, inform the user the epic is ready for manual merge.

          ## Post-Review Merge (if user requests)

          If the user asks you to merge the worktree, use gobby-merge tools:

          1. Start merge:
             merge_start(worktree_id="{{ variables.worktree_id }}",
                        source_branch="epic/{{ variables.session_task }}",
                        target_branch="{{ variables.target_branch }}")

          2. If conflicts exist, check status and resolve:
             merge_status(resolution_id=<id>)
             merge_resolve(conflict_id=<id>)  # AI-assisted resolution

          3. Apply the merge:
             merge_apply(resolution_id=<id>)

          4. If something goes wrong:
             merge_abort(resolution_id=<id>)

    allowed_tools: all

exit_condition: "task_tree_complete(variables.session_task)"

on_premature_stop:
  action: guide_continuation
  message: |
    You cannot stop yet. The epic task tree is not complete.

    Current state:
    - Epic: {{ variables.session_task }}
    - Worktree: {{ variables.worktree_path }}
    - Current agent: {{ variables.current_agent_run_id }}

    If an agent is running, check its status with get_agent_result().
    If no agent is running, use suggest_next_task() to find the next subtask.
    Continue until task_tree_complete({{ variables.session_task }}).
