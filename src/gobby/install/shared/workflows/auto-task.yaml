name: auto-task
description: |
  Autonomous task execution workflow.
  Stays in 'work' step until task_tree_complete().

  Key features:
  - Full tool access for implementation
  - Proper loop that stays in 'work' until task_tree_complete()
  - Blocks premature stop until tasks are done

  Usage:
    1. Create/claim a task via gobby-tasks
    2. Activate this workflow with session_task set to the task ID
    3. Work autonomously until all subtasks are closed
    4. Workflow exits when task tree is complete

version: "1.1"
type: step
enabled: false

# Workflow-scoped variables
variables:
  # Failsafe: force allow stop after N blocked attempts (resets on user prompt)
  premature_stop_max_attempts: 3

# Session-scoped shared variables (set on activation)
session_variables:
  session_task: null  # Task ID(s) to complete before exit

steps:
  - name: work
    description: "Work on assigned task until complete"

    on_enter:
      - action: inject_message
        content: |
          You are in autonomous task execution mode.

          Session task: {{ variables.session_task }}

          Work on this task and its subtasks until completion.
          Use suggest_next_task() to find available work.
          When all subtasks are closed, the task will be marked complete.

      # FUTURE: Uncomment to enable meeseeks spawning for subtasks
      # - action: inject_message
      #   content: |
      #     Consider spawning meeseeks agents for subtasks:
      #
      #     mcp__gobby__call_tool(
      #       server_name="gobby-agents",
      #       tool_name="spawn_agent",
      #       arguments={
      #         "prompt": "Complete task: {task_title}",
      #         "workflow": "meeseeks",
      #         "mode": "terminal",
      #         "default_variables": {
      #           "assigned_task_id": "{task_id}",
      #           "task_category": "code"
      #         }
      #       }
      #     )

    # Full tool access for implementation
    allowed_tools: all

    transitions:
      # Complete when task tree done
      - to: complete
        when: "task_tree_complete(variables.session_task)"

  - name: complete
    description: "Task work finished - terminal step"

    on_enter:
      - action: inject_message
        content: |
          Task complete! All subtasks for {{ variables.session_task }} have been closed.

          The auto-task workflow will now exit.
          You may stop the session or start a new task.

# Exit condition for entire workflow
# When this evaluates to true, the workflow can cleanly exit
# Uses task_tree_complete directly so stop is allowed when tasks are done
# (even if transition to 'complete' step hasn't fired yet)
exit_condition: "task_tree_complete(variables.session_task)"

# Handler for premature stop attempts
# Triggered when agent tries to stop but exit_condition is not met
on_premature_stop:
  action: guide_continuation
  message: "Task has incomplete subtasks. Use suggest_next_task() and continue working. Do not wait for user confirmation to proceed."
