name: merge
description: |
  Merge approved branch and cleanup isolation environment.

  Supports both clone and worktree isolation modes:
  - clone:    Merge via gobby-clones MCP tool, cleanup via delete_clone
  - worktree: Merge via git merge, cleanup via delete_worktree

  Steps:
  1. Merge the feature branch into target (usually dev)
  2. Clean up the isolation environment
  3. Optionally delete the feature branch (worktree mode)

version: "1.0"
type: step

variables:
  isolation_mode: "worktree"       # "clone" or "worktree"
  clone_id: null                   # Clone ID (when isolation_mode=clone)
  worktree_id: null                # Worktree ID (when isolation_mode=worktree)
  branch_name: null
  target_branch: dev
  merge_strategy: merge            # merge, squash, or rebase
  delete_branch: true
  merge_complete: false
  cleanup_complete: false

steps:
  - name: merge
    description: "Merge branch into target"
    on_enter:
      # Clone mode: merge via gobby-clones MCP tool
      - action: call_mcp_tool
        when: "variables.get('isolation_mode') == 'clone'"
        server_name: gobby-clones
        tool_name: merge_clone_to_target
        arguments:
          clone_id: "{{ variables.clone_id }}"
          target_branch: "{{ variables.target_branch }}"
        output_as: _merge_result

      - action: set_variable
        when: "variables.get('isolation_mode') == 'clone'"
        name: merge_complete
        value: true

      # Worktree mode: instruct LLM to do git merge
      - action: inject_message
        when: "variables.get('isolation_mode') == 'worktree'"
        content: |
          MERGE: Starting merge.

          Branch: {{ variables.branch_name }}
          Target: {{ variables.target_branch }}
          Strategy: {{ variables.merge_strategy }}

          Execute the merge:

          {% if variables.merge_strategy == 'squash' %}
          git checkout {{ variables.target_branch }}
          git merge --squash {{ variables.branch_name }}
          git commit -m "Merge {{ variables.branch_name }} (squashed)"
          {% elif variables.merge_strategy == 'rebase' %}
          git checkout {{ variables.branch_name }}
          git rebase {{ variables.target_branch }}
          git checkout {{ variables.target_branch }}
          git merge --ff-only {{ variables.branch_name }}
          {% else %}
          git checkout {{ variables.target_branch }}
          git merge {{ variables.branch_name }}
          {% endif %}

          After successful merge, set merge_complete to true:
          set_workflow_variable("merge_complete", true)

    allowed_tools:
      - Bash
      - Read
      - mcp__gobby__call_tool
      - mcp__gobby__list_tools
      - mcp__gobby__get_tool_schema

    transitions:
      - to: cleanup
        when: "variables.get('merge_complete', False)"

  - name: cleanup
    description: "Delete isolation environment and branch"
    on_enter:
      # Clone mode: delete the clone
      - action: call_mcp_tool
        when: "variables.get('isolation_mode') == 'clone'"
        server_name: gobby-clones
        tool_name: delete_clone
        arguments:
          clone_id: "{{ variables.clone_id }}"
        output_as: _cleanup_result

      - action: set_variable
        when: "variables.get('isolation_mode') == 'clone'"
        name: cleanup_complete
        value: true

      # Worktree mode: instruct LLM to cleanup
      - action: inject_message
        when: "variables.get('isolation_mode') == 'worktree'"
        content: |
          MERGE: Cleaning up.

          Worktree: {{ variables.worktree_id }}
          Delete branch: {{ variables.delete_branch }}

          Remove the worktree:

          mcp__gobby__call_tool(
            server_name="gobby-worktrees",
            tool_name="delete_worktree",
            arguments={"worktree_id": "{{ variables.worktree_id }}"}
          )

          Or manually:
          git worktree remove <path>
          {% if variables.delete_branch %}
          git branch -D {{ variables.branch_name }}
          {% endif %}

          After cleanup, set cleanup_complete to true:
          set_workflow_variable("cleanup_complete", true)

    allowed_tools:
      - Bash
      - mcp__gobby__call_tool
      - mcp__gobby__list_tools
      - mcp__gobby__get_tool_schema

    transitions:
      - to: complete
        when: "variables.get('cleanup_complete', False)"

  - name: complete
    description: "Merge and cleanup done"
    on_enter:
      - action: inject_message
        content: |
          MERGE: Complete!

          Branch {{ variables.branch_name }} has been merged into {{ variables.target_branch }}.
          {% if variables.isolation_mode == 'clone' %}Clone {{ variables.clone_id }} has been removed.{% endif %}
          {% if variables.isolation_mode == 'worktree' %}Worktree {{ variables.worktree_id }} has been removed.{% endif %}

exit_condition: "current_step == 'complete'"
